<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
  <!-- Global Site Tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-107512713-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments)};
    gtag('js', new Date());

    gtag('config', 'UA-107512713-1');
  </script>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="img/favicon3.ico" type="image/x-icon">
    <title>Steem Bot Tracker</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="scripts/bootstrap-slider.min.css">
    <script src="scripts/bootstrap-slider.min.js"></script>
    <link href="https://unpkg.com/bootstrap-switch/dist/css/bootstrap3/bootstrap-switch.css" rel="stylesheet">
    <script src="https://unpkg.com/bootstrap-switch"></script>

    <script src="https://cdn.steemjs.com/lib/latest/steem.min.js"></script>
    <script src="scripts/utils.js?v=4"></script>

    <script type="text/javascript">
        steem.api.setOptions({ url: 'https://api.steemit.com' });
    </script>

    <style type="text/css">
      body { padding-top: 70px; }
      .progress-bar { color: black; }
      .glyphicon-comment { margin-left: 5px; }
      h3 { margin-top: 0; }
      .value { font-weight: bold; }
      dl.values { margin-top: 10px; margin-bottom: 0; }
      .userpic {
		  display: inline-block;
		  background-size: cover;
		  background-repeat: no-repeat;
		  background-position: 50% 50%;
		  border-radius: 25%;
		  width: 24px;
		  height: 24px;
		  margin-right: 5px;
		}
      .form-control {
        display: inline;
        width: 80%;
      }

      .dl-horizontal dt { width: 200px; }
      .dl-horizontal dd { margin-left: 220px; }
      .slider.slider-horizontal { width: 80%; }
    </style>
</head>
<body>
  <nav class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="#">
          <img alt="Steem Post Promoter" src="img/logo.png" height="20" width="20">
        </a>
        <a class="navbar-brand" href="bottracker.html">Steem Bot Tracker</a>
      </div>

      <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
        <ul class="nav navbar-nav">
          <li ><a href="bottracker.html#bid">Bid-Based Voting Bots</a></li>
          <li><a href="bottracker.html#paid">Paid Upvote Bots</a></li>
          <li><a href="bottracker.html#free">Other Bots</a></li>
          <li><a href="#">Bot Owner Config</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container">
    <div class="alert alert-info">
    </div>

    <div class="well">
      <div class="form-group">
        <label for="account_name">Your Account Name</label>
        <div>
          <span style="font-size: 1.5em; color: #888888;">@&nbsp;</span><input type="text" class="form-control" id="account_name" placeholder="Account Name">&nbsp;
          <span id="account_ok" class="glyphicon glyphicon-ok" aria-hidden="true" style="display: none; color: green; font-size: 2.5em; vertical-align: bottom;"></span>
          <span id="account_bad" class="glyphicon glyphicon-remove" aria-hidden="true" style="display: none; color: red; font-size: 2.5em; vertical-align: bottom;"></span>
        </div>
      </div>
      <div class="form-group">
        <label for="post_link">Post/Comment Link</label>
        <div>
          <input type="text" class="form-control" id="post_link" placeholder="Post/Comment Link" value="https://steemit.com/utopian-io/@steem-plus/steemplus-is-now-running-well-with-the-new-steemit-interface">&nbsp;
          <span id="post_ok" class="glyphicon glyphicon-ok" aria-hidden="true" style="display: none; color: green; font-size: 2.5em; vertical-align: bottom;"></span>
          <span id="post_bad" class="glyphicon glyphicon-remove" aria-hidden="true" style="display: none; color: red; font-size: 2.5em; vertical-align: bottom;"></span>
        </div>
      </div>
      <div class="form-group" id="reward_slider_group" style="display: none;">
        <label for="post_total_slider">Expected Total Post Rewards</label>
        <div><input id="post_total_slider" type="text" class="span2" value="" data-slider-min="0" data-slider-max="500" data-slider-step="1" data-slider-value="100"/></div>
      </div>

      <button id="btn_submit" class="btn btn-default" onclick="calculate();">Calculate</button>
    </div>

    <div id="result" class="alert alert-success">
      <dl class="dl-horizontal">
        <dt>Vote Value ($):</dt>
        <dd><span id="vote_value"></span></dd>
        <dt>Curation Reward (STEEM):</dt>
        <dd><span id="curation_steem"></span></dd>
        <dt>Curation Reward ($):</dt>
        <dd><span id="curation_sbd"></span></dd>
      </dl>
    </div>
  </div>

  <script type="text/javascript">
    const FULL_CURATION_TIME = 30 * 60 * 1000;
    const CURATION_RATE = 0.25;
    var data = {};

    function loadAccount(cb) {
      steem.api.getAccounts([$('#account_name').val()], function(err, result) {
        data.account = result[0];
        cb();
      });
    }

    function loadPost(cb) {
      var link = $('#post_link').val();
      var permLink = link.substr(link.lastIndexOf('/') + 1);
      var author = link.substring(link.lastIndexOf('@') + 1, link.lastIndexOf('/'));

      steem.api.getContent(author, permLink, function (err, result) {
        if (!err && result && result.id > 0) {
          data.post = result;          
        }

        cb();
      });
    }

    $('#post_link').focusout(function (e) {
      loadPost(function () {
        var ok = $('#post_ok');
        var bad = $('#post_bad');
        ok.hide();
        bad.hide();

        if (data.post) {
          ok.show();

          if (data.account && data.account.name)
            calculate();

        } else
          bad.show();
      });
    });

    $('#account_name').focusout(function (e) {
      loadAccount(function () {
        var ok = $('#account_ok');
        var bad = $('#account_bad');
        ok.hide();
        bad.hide();

        if (data.account && data.account.name) {
          ok.show();

          if (data.post)
            calculate();

        } else
          bad.show();        
      });
    });

    function calculate() {
      data.rshares_before = 0;
      data.rshares_vote = 0;
      data.rshares_total = 0;
      data.pre_30_min_pct = 0;

      var votes = data.post.active_votes;
      votes.sort(function(a, b) { return new Date(a.time + 'Z') - new Date(b.time + 'Z'); });

      var created = new Date(data.post.created + 'Z');
      data.post_paid_out = (new Date() - created) > (7 * 24 * 60 * 60 * 1000);

      for(var i = 0; i < votes.length; i++) {
          var vote = votes[i];
          var vote_time = new Date(vote.time + 'Z');
          var rshares = parseInt(vote.rshares);

          if(vote.voter == data.account.name) {
            data.pre_30_min_pct = Math.min(vote_time - created, FULL_CURATION_TIME) / FULL_CURATION_TIME;
            data.rshares_vote = rshares;
          }

          if(data.rshares_vote == 0)
            data.rshares_before += rshares;

          data.rshares_total += rshares;
      }

      if (!data.post_paid_out) {
        // If the account has not already voted, assume they vote right now at full power
        if (data.rshares_vote == 0) {
          data.rshares_vote = getVoteRShares(100, data.account);
          data.pre_30_min_pct = Math.min(new Date() - created, FULL_CURATION_TIME) / FULL_CURATION_TIME;
        }

        var slider = $('#post_total_slider');
        var pending_payout = Math.ceil(parseFloat(data.post.pending_payout_value) + getVoteValue(100, data.account));
        slider.attr('data-slider-min', pending_payout);
        slider.attr('data-slider-value', pending_payout);

        $('#post_total_slider').slider({});
        $('#post_total_slider').on("slide", function (e) {
          if (data.rshares_vote > 0)
            showRewards();
        });

        $('#reward_slider_group').show();
      }

      showRewards(true);
    }

    function showRewards(log) {
      if(!data.post_paid_out)
        data.rshares_total = parseInt($('#post_total_slider').val()) / steemPrice * recentClaims / rewardBalance;

      var curation_rshares = (Math.sqrt(data.rshares_before * CURATION_RATE + data.rshares_vote * CURATION_RATE) - Math.sqrt(data.rshares_before * CURATION_RATE)) * Math.sqrt(data.rshares_total * CURATION_RATE) * data.pre_30_min_pct;
      var curation_steem = curation_rshares * rewardBalance / recentClaims;
      var curation_sbd = curation_steem * steemPrice;

      if(log) {
        console.log({
          "data.rshares_before": data.rshares_before,
          "data.rshares_vote": data.rshares_vote,
          "data.rshares_total": data.rshares_total,
          "curation_rshares": curation_rshares,
          "reward_steem": curation_steem,
          "dollar_amount" : curation_sbd
        });
      }

      $('#vote_value').text('$' + getVoteValue(100, data.account).formatMoney());
      $('#curation_steem').text(curation_steem.formatMoney(3) + ' STEEM POWER');
      $('#curation_sbd').text('$' + curation_sbd.formatMoney())
    }

    function showResult(success, message) {
      var result = $('#result');
      result.show();
      result.text(message);
    }
  </script>
</body>
</html>
